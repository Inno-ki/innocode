name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Override version (e.g., 1.0.1). If empty, use tag version."
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true

      - uses: ./.github/actions/setup-bun

      - name: Resolve version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          else
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
          fi
          echo "CHANNEL=latest" >> $GITHUB_ENV
      - name: Show release env
        run: |
          echo "VERSION=${VERSION}"
          echo "CHANNEL=${CHANNEL}"

      - name: Configure npm auth
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure GitHub release exists
        run: |
          if ! gh release view "v${VERSION}" >/dev/null 2>&1; then
            gh release create "v${VERSION}" --title "v${VERSION}" --notes "" --draft
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build binaries
        run: |
          OPENCODE_VERSION="${VERSION}" OPENCODE_CHANNEL="${CHANNEL}" OPENCODE_RELEASE="1" bun run --cwd packages/opencode script/build.ts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish artifacts
        run: |
          OPENCODE_VERSION="${VERSION}" OPENCODE_CHANNEL="${CHANNEL}" OPENCODE_RELEASE="1" bun run --cwd packages/opencode script/publish.ts
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}

      - name: Update Scoop manifest
        run: |
          set -euo pipefail
          tempdir="$(mktemp -d)"
          asset="innocode-windows-x64.zip"
          url="https://github.com/Inno-ki/innocode/releases/download/v${VERSION}/${asset}"
          curl -fsSL "$url" -o "${tempdir}/${asset}"
          hash="$(sha256sum "${tempdir}/${asset}" | awk '{print $1}')"
          repo="https://x-access-token:${SCOOP_TOKEN}@github.com/Inno-ki/scoop-bucket.git"
          git clone "$repo" "${tempdir}/scoop-bucket"
          cat > "${tempdir}/scoop-bucket/innocode.json" <<EOF
          {
            "version": "${VERSION}",
            "description": "The AI coding agent built for the terminal.",
            "homepage": "https://innocode.io",
            "license": "MIT",
            "url": "${url}",
            "hash": "${hash}",
            "bin": "innocode.exe"
          }
          EOF
          cd "${tempdir}/scoop-bucket"
          git add innocode.json
          git commit -m "Update innocode to v${VERSION}"
          git push
        env:
          SCOOP_TOKEN: ${{ secrets.SCOOP_TOKEN }}

      - name: Verify release artifacts
        run: |
          npm view innocode version
          curl -fsSL https://innocode.io/install | head -n 3
          gh release view "v${VERSION}" --json assets
          docker pull "ghcr.io/inno-ki/innocode:${VERSION}"
          docker pull "ghcr.io/inno-ki/innocode:latest"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
